<div class="clearfix">
  <h1 class="float-left">Virtual Machines</h1>
  <% if current_user.employee_or_admin? %>
    <%= button_to "New Request", new_request_path,
      method: :get,
      class: "btn btn-primary float-right mt-3" %>
    <%= button_to "All Requests", requests_path,
      method: :get,
      class: "btn btn-primary float-right mt-3 mr-3" %>
  <% end %>
</div>

<%= link_to "Active machines (#{@vms&.size}) <small>&#x25bc;</small>".html_safe, '#active' %><br />
<%= link_to "To be archived (#{@pending_archivation_vms&.size}) <small>&#x25bc;</small>".html_safe, '#to_be_archived' %><br />
<%= link_to "To be revived (#{@pending_reviving_vms&.size}) <small>&#x25bc;</small>".html_safe, '#to_be_revived' %><br />
<%= link_to "Archived machines (#{@archived_vms&.size}) <small>&#x25bc;</small>".html_safe, '#archived' %>

<h2 id="active">Active machines</h2>

<input class="mb-3 bg-secondary border-0 rounded text-white filter-box" type="text" id="filter_active" onkeyup="filter_table('filter_active', 'vms_active', document)" placeholder="Search">

<table data-toggle="table" class="table" id="vms_active">
  <thead>
  <tr>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-left">Name</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Project</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Responsible</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-right">Status</th>
  </tr>
  </thead>
  <tbody>
  <% @vms&.each do |vm| %>
    <tr>
      <td class="table-active">
        <%= link_to vm.name,
          {controller: :vms, action: 'show', id: vm.name},
          method: :get, class: "btn btn-link"  %>
      </td>
      <td class="table-active"><%= 'lorem' %></td>
      <td class="table-active"><%= 'ipsum' %></td>
      <td class="table-active align-middle">
        <div class="<%= 'boot-time mt-1' if vm.powered_on? %>">
          <div class="round
            <%= vm.powered_on? ? 'bg-success' : 'bg-warning mt-1'  %>">
          </div>
          <%= vm.boot_time.to_s.strip if vm.powered_on? %>
        </div>
        <% if vm.sudo_users.include?(current_user) || current_user.admin? %>
          <% if vm.vm_ware_tools? %>
            <%= link_to '',
              {controller: :vms, action: 'change_power_state', id: vm.name},
              method: :post,
              data: { confirm: 'Are you sure?' },
              class: "btn-manage float-right #{ vm.powered_on? ? 'stop' : 'play' }" %>
            <% if vm.powered_on? %>
              <%= link_to '',
                {controller: :vms, action: 'reboot_guest_os', id: vm.name},
                method: :post,
                data: { confirm: 'Are you sure?' },
                class: "btn-manage float-right replay" %>
            <% end %>
          <% end %>
        <% end %>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>

<h2 id="to_be_archived">To be archived</h2>

<input class="mb-3 bg-secondary border-0 rounded text-white filter-box" type="text" id="filter_to_be_archived" onkeyup="filter_table('filter_to_be_archived', 'vms_to_be_archived', document)" placeholder="Search">

<table data-toggle="table" class="table" id="vms_to_be_archived">
  <thead>
  <tr>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-left">Name</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Project</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Responsible</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-right">Status</th>
  </tr>
  </thead>
  <tbody>
  <% @pending_archivation_vms&.each do |vm| %>
    <tr>

      <td class="table-active">
        <%= link_to vm.name,
          {controller: :vms, action: 'show', id: vm.name},
          method: :get, class: "btn btn-link"  %>
      </td>
      <td class="table-active"><%= 'lorem' %></td>
      <td class="table-active"><%= 'ipsum' %></td>
      <td class="table-active">
        <div class="<%= 'boot-time mt-1' if vm.powered_on? %>">
          <div class="round
            <%= vm.powered_on? ? 'bg-success' : 'bg-warning mt-1'  %>">
          </div>
          <%= vm.boot_time.to_s.strip if vm.powered_on? %>
        </div>
        <%if current_user.admin? && vm.archivable? %>
          <%= link_to '',
                      {controller: :vms, action: 'archive_vm', id: vm.name},
                      method: :post,
                      class: "btn-manage float-right checkmark" %>
        <% end %>
        <%= link_to '',
                    {controller: :vms, action: 'revive_vm', id: vm.name},
                    method: :post,
                    class: "btn-manage float-right cross" %>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>

<h2 id="to_be_revived">To be revived</h2>

<input class="mb-3 bg-secondary border-0 rounded text-white filter-box" type="text" id="filter_to_be_revived" onkeyup="filter_table('filter_to_be_revived', 'vms_to_be_revived', document)" placeholder="Search">

<table data-toggle="table" class="table" id="vms_to_be_revived">
  <thead>
  <tr>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-left">Name</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Project</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-right">Responsible</th>
  </tr>
  </thead>
  <tbody>
  <% @pending_reviving_vms&.each do |vm| %>
    <tr>

      <td class="table-active">
        <%= link_to vm.name,
          {controller: :vms, action: 'show', id: vm.name},
          method: :get, class: "btn btn-link"  %>
      </td>
      <td class="table-active"><%= 'lorem' %></td>
      <td class="table-active"><%= 'ipsum' %>
        <% if current_user.admin? %>
          <%= link_to '',
            {controller: :vms, action: 'revive_vm', id: vm.name},
            method: :post,
            class: "btn-manage float-right checkmark" %>

        <% end %>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>

<h2 id="archived">Archived machines</h2>

<input class="mb-3 bg-secondary border-0 rounded text-white filter-box" type="text" id="filter_archived" onkeyup="filter_table('filter_archived', 'vms_archived', document)" placeholder="Search">

<table data-toggle="table" class="table" id="vms_archived">
  <thead>
  <tr>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-left">Name</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Project</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-right">Responsible</th>
  </tr>
  </thead>
  <tbody>
  <% @archived_vms&.each do |vm| %>
    <tr>
      <td class="table-active">
        <%= link_to vm.name,
          {controller: :vms, action: 'show', id: vm.name},
          method: :get, class: "btn btn-link"  %>
      </td>
      <td class="table-active"><%= 'lorem' %></td>
      <td class="table-active align-middle">
        ipsum
        <% if current_user.admin? %>
          <%= link_to '',
            {controller: :vms, action: 'revive_vm', id: vm.name},
            method: :post,
            class: "btn-manage float-right arrow-up" %>
        <% else %>
          <%= link_to '',
            {controller: :vms, action: 'request_vm_revive', id: vm.name},
            method: :post,
            class: "btn-manage float-right arrow-up" %>
        <% end %>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>

<!-- Minified script sources for sortable tables -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css"
      xmlns="http://www.w3.org/1999/html">
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
<script>
document.addEventListener("turbolinks:before-visit", function (event) {
    var origin = window.location.href;
    var destination = event.data.url;
    if (origin.match(/#/) === null) {
        if (origin[origin.length - 1] === "/") {
            origin = origin.substring(0, origin.length - 1);
        }
    }
    else {
        var hashIndex = origin.indexOf('#');
        if (hashIndex > 0 && origin[hashIndex - 1] === "/")
            origin = "" + origin.substring(0, (hashIndex - 1)) + origin.substring(hashIndex);
    }
    if (destination.match(/#/) === null) {
        if (destination[destination.length - 1] === "/") {
            destination = destination.substring(0, destination.length - 1);
        }
    }
    else {
        var hashIndex = destination.indexOf('#');
        if (hashIndex > 0 && destination[hashIndex - 1] === "/")
            destination = "" + destination.substring(0, (hashIndex - 1)) + destination.substring(hashIndex);
    }

    if (origin === destination)
        return;

    var shorterLength = Math.min(origin.length, destination.length);
    if (((origin.match(/#/) !== null) && (destination.match(/#/) !== null)) &&
        (origin.indexOf("#") === destination.indexOf("#"))) {
        shorterLength = Math.min(origin.indexOf("#"), destination.indexOf("#"));
    }
    if (origin.substring(0, shorterLength) !== destination.substring(0, shorterLength)) {
        return;
    }
    if (destination.length > shorterLength && destination[shorterLength] === "#") {
        event.preventDefault();
        var urlHashMinusHash = destination.substring(destination.indexOf('#')).substring(1);
        var elem = document.getElementById(urlHashMinusHash);
        if (elem != null)
            elem.scrollIntoView();
        return;
    }

    if (origin.length > shorterLength && origin[shorterLength] === "#") {
        event.preventDefault();
        $("html, body").animate({ scrollTop: 0 }, "slow");
        return;
    }
  });
</script>