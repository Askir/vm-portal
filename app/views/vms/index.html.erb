<h1>
  Virtual Machines
</h1>
<small class="text-muted">This is the overview page for all currently existing VMs.</small>

<%= form_tag({controller: "vms", action: "index"}, method: "get", class: "nifty_form") do %>
<table class="table-bar">
  <tbody>
    <tr>
      <td>
        <%=link_to(fa_icon('plus'),
        {controller: :vms, action: 'new'},
        method: :get, class: 'btn btn-info') %>
      </td>
      <td>
        <div class="dropdown">
          <button class="fa fa-filter btn btn-info" id="dropdownMenuButton" data-toggle="dropdown" aria-expanded="false">
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <div>
              <%= check_box_tag(:up_vms, true, @parameters.include?('up_vms')) %>
              Connected
            </div>
            <div>
              <%= check_box_tag(:down_vms, true, @parameters.include?('down_vms')) %>
              Not connected
            </div>
            <div class="dropdown-divider"></div>
            <%= submit_tag "Filter", class: "btn btn-info small-btn" %>
          </div>
        </div>
      </td>
      <td>
        <%= link_to "Requests",
          {controller: :requests, action: 'index'},
          method: :get, class: "btn btn-info" %>
      </td>
    </tr></tbody></table>
<% end %>

<table data-toggle="table" class="table">
  <thead>
  <tr>
    <th scope="col" data-sortable="true">VM Name</th>
    <th scope="col" data-sortable="true">Running Since</th>
    <th scope="col">Actions</th>
  </tr>
  </thead>
  <tbody>
  <% @vms.each do |vm| %>
    <tr>
      <td><%= link_to vm.name,
                      {controller: :vms, action: 'show', id: vm.name},
                      method: :get, class: "btn btn-link"  %></td>
      <td><%= vm.boot_time if vm.powered_on? %></td>
      <td>
        <% if vm.vm_ware_tools? %>
          <% if vm.powered_on? %>
            <%= button_to "Shutdown", {controller: :vms, action: 'change_power_state', id: vm.name}, method: :post, data: { confirm: 'Are you sure?' }, class: "btn btn-danger" %>
          <% else %>
            <%= button_to "Start", {controller: :vms, action: 'change_power_state', id: vm.name}, method: :post, class: "btn btn-success" %>
          <% end %>
        <% else %>
          <p class="text-muted">VMWare tools are not installed</p>
        <% end %>
      </td>
    <tr>
  <% end %>
  <% @pending_archivation_vms.each  do |vm| %>
  <tr class="table-danger">
    <td ><%= link_to vm.name,
                  {controller: :vms, action: 'show', id: vm.name},
                  method: :get, class: "btn btn-link"  %>
    </td>
    <td><%= vm.boot_time if vm.powered_on? %></td>
    <td>
      <%if current_user.admin? %>
        <%= button_to "Confirm archiving", {controller: :vms, action: 'archive_vm', id: vm.name }, method: :post, class: "btn btn-danger" %>
      <% else %>
        <p class="text-info">Waiting for confirmation by an admin</p>
      <% end %>
    </td>
  </tr>
  <% end %>
  </tbody>
</table>

<% if current_user.employee_or_admin? %>
  <table class="table">
    <tbody>
    <tr>
      <td><%= button_to "Requests",
                        {controller: :requests, action: 'index'},
                        method: :get, class: "btn btn-info" %></td>
      <td><%= button_to "New",
                        {controller: :vms, action: 'new'},
                        method: :get, class: "btn btn-info" %></td>
    </tr>
    </tbody>
  </table>
<% end %>

<h2>Archived VMs</h2>
<table data-toggle="table" class="table archived">
  <thead>
  <tr>
    <th scope="col" data-sortable="true">VM Name</th>
    <th scope="col">Actions</th>
  </tr>
  </thead>
  <tbody>
  <% @pending_reviving_vms.each  do |vm| %>
    <tr class="table-success">
      <td ><%= link_to vm.name,
                       {controller: :vms, action: 'show', id: vm.name},
                       method: :get, class: "btn btn-link"  %></td>
      <td>
        <%if current_user.admin? %>
          <%= button_to "Confirm reviving", {controller: :vms, action: 'revive_vm', id: vm.name}, method: :post, class: "btn btn-danger" %>
        <% else %>
          <p class="text-info">Waiting for confirmation by an admin</p>
        <% end %>
      </td>
    </tr>
  <% end %>
  <% @archived_vms.each do |vm| %>
    <tr>
      <td><%= link_to vm.name,
                      {controller: :vms, action: 'show', id: vm.name},
                      method: :get, class: "btn btn-link"  %></td>
      <td></td>
    <tr>
  <% end %>

  </tbody>
</table>

<!-- Minified script sources for sortable tables -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css"
      xmlns="http://www.w3.org/1999/html">
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
