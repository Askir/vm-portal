<div class="clearfix">
  <h1 class="float-left">Virtual Machines</h1>
  <% if current_user.employee_or_admin? %>
    <%= button_to "+", new_request_path,
      method: :get,
      class: "btn btn-primary float-right mt-3" %>
  <% end %>
</div>

<input class="mb-3 bg-secondary border-0 rounded text-white filter-box" type="text" id="filter_active" onkeyup="filterTables('filter_active', ['vms_active', 'vms_to_be_archived', 'vms_to_be_revived', 'vms_archived'])" placeholder="Search">

<% if should_be_shown @vms %>
<h2 id="active">Active machines</h2>

<table data-toggle="table" class="table" id="vms_active">
  <thead>
  <tr>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-left">Name</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Project</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Responsible</th>
  </tr>
  </thead>
  <tbody>
  <% @vms&.each do |vm| %>
    <tr>
      <td class="table-active">
        <%= render 'vm_status', vm: vm %>
        <%= link_to vm.name,
          {controller: :vms, action: 'show', id: vm.name},
          method: :get, class: "btn btn-link"  %>
      </td>
      <td class="table-active">
        <% if vm.project.nil? %>
          No project found!
        <% else %>
          <% debug vm.project %>
          <%= link_to vm.project.name, vm.project %>
        <% end %>
      </td>
      <td class="table-active">
        <% if vm.responsible_users.empty? %>
          No responsible users found!
        <% else %>
          <ul class="list-unstyled">
            <% vm.responsible_users.each do |user| %>
              <li><%= link_to user.name, user %></li>
            <% end %>
          </ul>
        <% end %>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>
<% end %>

<% if should_be_shown @pending_archivation_vms %>
<h2 id="to_be_archived">To be archived</h2>

<table data-toggle="table" class="table" id="vms_to_be_archived">
  <thead>
  <tr>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-left">Name</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Project</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Responsible</th>
  </tr>
  </thead>
  <tbody>
  <% @pending_archivation_vms&.each do |vm| %>
    <tr>

      <td class="table-active">
        <%= render 'vm_status', vm: vm %>
        <%= link_to vm.name,
          {controller: :vms, action: 'show', id: vm.name},
          method: :get, class: "btn btn-link"  %>
      </td>
      <td class="table-active">
        <% if vm.project.nil? %>
          No project found!
        <% else %>
          <%= link_to vm.project.name, vm.project %>
        <% end %>
      </td>
      <td class="table-active">
        <% if vm.responsible_users.empty? %>
          No responsible users found!
        <% else %>
          <ul class="list-unstyled">
            <% vm.responsible_users.each do |user| %>
              <li><%= link_to user.name, user %></li>
            <% end %>
          </ul>
        <% end %>
        <%if current_user.admin? && vm.archivable? %>
          <%= link_to '',
                      {controller: :vms, action: 'archive_vm', id: vm.name},
                      method: :post, data: { confirm: 'Are you sure you want to archive this VM?' },
                      class: "btn-manage float-right checkmark" %>
        <% end %>
        <%= link_to '',
                    {controller: :vms, action: 'revive_vm', id: vm.name},
                    method: :post,
                    class: "btn-manage float-right cross" %>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>

<% end %>

<% if should_be_shown @pending_reviving_vms %>
<h2 id="to_be_revived">To be revived</h2>

<table data-toggle="table" class="table" id="vms_to_be_revived">
  <thead>
  <tr>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-left">Name</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Project</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-right">Responsible</th>
  </tr>
  </thead>
  <tbody>
  <% @pending_reviving_vms&.each do |vm| %>
    <tr>

      <td class="table-active">
        <%= link_to vm.name,
          {controller: :vms, action: 'show', id: vm.name},
          method: :get, class: "btn btn-link"  %>
      </td>
      <td class="table-active">
        <% if vm.project.nil? %>
          No project found!
        <% else %>
          <%= link_to vm.project.name, vm.project %>
        <% end %>
      </td>
      <td class="table-active">
        <% if vm.responsible_users.empty? %>
          No responsible users found!
        <% else %>
          <ul class="list-unstyled">
            <% vm.responsible_users.each do |user| %>
              <li><%= link_to user.name, user %></li>
            <% end %>
          </ul>
        <% end %>
        <% if current_user.admin? %>
          <%= link_to '',
            {controller: :vms, action: 'revive_vm', id: vm.name},
            method: :post,
            class: "btn-manage float-right checkmark" %>

        <% end %>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>

<% end %>

<% if should_be_shown @archived_vms %>
<h2 id="archived">Archived machines</h2>


<table data-toggle="table" class="table" id="vms_archived">
  <thead>
  <tr>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-left">Name</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white">Project</th>
    <th scope="col" data-sortable="true" class="bg-primary text-white rounded-right">Responsible</th>
  </tr>
  </thead>
  <tbody>
  <% @archived_vms&.each do |vm| %>
    <tr>
      <td class="table-active">
        <%= link_to vm.name,
          {controller: :vms, action: 'show', id: vm.name},
          method: :get, class: "btn btn-link"  %>
      </td>
      <td class="table-active">
        <% if vm.project.nil? %>
          No project found!
        <% else %>
          <%= link_to vm.project.name, vm.project %>
        <% end %>
      </td>
      <td class="table-active align-middle">
        <% if vm.responsible_users.empty? %>
          No responsible users found!
        <% else %>
          <ul class="list-unstyled">
            <% vm.responsible_users.each do |user| %>
              <li><%= link_to user.name, user %></li>
            <% end %>
          </ul>
        <% end %>
        <% if current_user.admin? %>
          <%= link_to '',
            {controller: :vms, action: 'revive_vm', id: vm.name},
            method: :post,
            class: "btn-manage float-right arrow-up" %>
        <% else %>
          <%= link_to '',
            {controller: :vms, action: 'request_vm_revive', id: vm.name},
            method: :post,
            class: "btn-manage float-right arrow-up" %>
        <% end %>
      </td>
    </tr>
  <% end %>
  </tbody>
</table>

<% end %>

<!-- Minified script sources for sortable tables -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.css"
      xmlns="http://www.w3.org/1999/html">
<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
